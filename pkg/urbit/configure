#!/usr/bin/env bash

set -euo pipefail

URBIT_VERSION="$(cat ./version)"

deps="                                                                \
  curl gmp sigsegv argon2 ed25519 ent h2o scrypt uv murmur3 secp256k1 \
  softfloat3 aes_siv ssl crypto z lmdb ge-additions pthread           \
"

headers="             \
  ivory.h ca-bundle.h \
"

echo '#pragma once' >include/config.h

defmacro () {
  echo "#define $1 $2" >>include/config.h
}

xxd () {
  cch=0
  echo "unsigned char $2[] = {"
  while IFS='' read line
  do
    for i in $line
    do
      echo -n " 0x$i,"
      cch=$((cch+1))
    done
    echo
  done < <(od -An -v -tx1 $1)
  echo "};"
  echo "unsigned int $2_len = $cch;"
}

defmacro URBIT_VERSION "\"$URBIT_VERSION\""

[ -n "${MEMORY_DEBUG-}" ]     && defmacro U3_MEMORY_DEBUG 1
[ -n "${MEMORY_LOG-}" ]       && defmacro U3_MEMORY_LOG 1
[ -n "${CPU_DEBUG-}" ]        && defmacro U3_CPU_DEBUG 1
[ -n "${EVENT_TIME_DEBUG-}" ] && defmacro U3_EVENT_TIME_DEBUG 1

if [ -n "${HOST-}" ]
then os=$(sed 's$^[^-]*-\([^-]*\)-.*$\1$' <<< "$HOST")
     cpu=$(sed 's$-.*$$' <<< ${HOST})
else os=$(uname -s)
     cpu=$(uname -m)
fi

case $(tr A-Z a-z <<< $cpu) in
  unknown)
     defmacro U3_OS_ENDIAN_little 1
     ;;
  i386)
     defmacro U3_OS_ENDIAN_little 1
     ;;
  i686)
     defmacro U3_OS_ENDIAN_little 1
     ;;
  x86_64)
     defmacro U3_OS_ENDIAN_little 1
     ;;
  aarch64)
     defmacro U3_OS_ENDIAN_little 1
     defmacro U3_CPU_aarch64 1
     ;;
  *)
     echo "Unknown or unsupported CPU: '$cpu'" >&2
     exit 1
     ;;
esac

# TODO Determine if the target cpu is little or big endian.
case $(tr A-Z a-z <<< $os) in
  *mingw*)
     # ensure required mingw packages are installed
     mpkgs=(cmake curl gcc jq libsigsegv libuv make wslay)
     pacman -S --needed autoconf automake-wrapper libtool patch ${mpkgs[@]/#/mingw-w64-x86_64-}

     # support running off a tarball that doesn't contain binary pills
     (( $(stat -c %s ../../bin/ivory.pill) > 512 )) || curl -L https://github.com/urbit/urbit/raw/urbit-v$URBIT_VERSION/bin/ivory.pill > ../../bin/ivory.pill

     # poor man's nix-shell
     declare -a cdirs
     declare -a ldirs
     . <(jq -sr '
add|to_entries|.[]|select(.value.mingw)|.key as $key|"../\(.key)" as $dir|(if .value.url then "
if [ ! -d \($dir) ]
then
  mkdir -p \($dir)
  pushd \($dir)
  curl -L \(.value.url)|(tar --strip \(.value.mingw.strip+1) -xzf - || true)
  popd
fi" else "" end) + "
pushd \($dir)
if [ ! -e .mingw~ ]
then" + ("../urbit/compat/mingw/\($key).patch"|"
  [ -e \(.) ] && patch -p 1 <\(.)") + "
  \(.value.mingw.prepare//"")
  touch .mingw~
fi
make \(.value.mingw.make//"")
popd
\(.value.mingw.include//"."|if type == "array" then .[] else . end|"cdirs+=(-I../\($key)/\(.))
")\(.value.mingw.lib//"."|if type == "array" then .[] else . end|"ldirs+=(-L../\($key)/\(.))
")"' ../../nix/sources.json ../../nix/sources-mingw.json)

     [ -e include/ca-bundle.h ] || xxd /etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt include_ca_bundle_crt >include/ca-bundle.h
     [ -e include/ivory.h     ] || xxd ../../bin/ivory.pill u3_Ivory_pill >include/ivory.h

     defmacro U3_OS_mingw 1
     defmacro U3_OS_TERM_dumb 1

     # increase default thread stack size and link Windows implibs
     ldextra="-Wl,--stack,67108864 -lbcrypt -lntdll -lws2_32"
     # libcurl implibs
     ldextra="$ldextra -lzstd"
     # libuv implibs
     ldextra="$ldextra -luserenv -liphlpapi -lpsapi"
     vcompat=mingw
     CFLAGS="${CFLAGS-} ${cdirs[@]} -DCURL_STATICLIB -DH2O_NO_UNIX_SOCKETS -Icompat/mingw"
     LDFLAGS="${LDFLAGS-} -static ${ldirs[@]}"
     PKG_CONFIG="echo"
     ;;
  *linux*)
     defmacro U3_OS_linux 1
     defmacro U3_OS_PROF 1
     ;;
  *darwin*)
     defmacro U3_OS_osx 1
     defmacro U3_OS_PROF 1
     ;;
  *apple*)
     defmacro U3_OS_osx 1
     defmacro U3_OS_PROF 1
     ;;
  *freebsd*)
     defmacro U3_OS_bsd 1
     osdeps="kvm"
     ;;
  *openbsd*)
     defmacro U3_OS_bsd 1
     ;;
  *)
     echo "Unknown or unsupported OS: '$os'" >&2
     exit 1
     ;;
esac

for dep in ${osdeps-} $deps
do LDFLAGS="${LDFLAGS-} -l$dep"
   ${PKG_CONFIG-pkg-config} --cflags --libs $dep 2>/dev/null || true
done

for header in $headers
do LDFLAGS="${LDFLAGS-} -I$header"
done

cat >config.mk <<EOF
CFLAGS  := ${CFLAGS-} -funsigned-char -ffast-math -fcommon -std=gnu99
LDFLAGS := $LDFLAGS ${ldextra-}
CC      := ${CC-cc}
compat  := ${vcompat-posix}
EOF

echo == config.mk == >&2
cat config.mk >&2

echo == include/config.h == >&2
cat include/config.h >&2
